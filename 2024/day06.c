#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>

extern const char* data;
#define MAP_WIDTH  130
#define MAP_HEIGHT 130
#define PART 2

enum { DIR_NORTH, DIR_EAST, DIR_SOUTH, DIR_WEST, NUM_DIRECTIONS };

typedef struct guard_s
{
    int     PosX;
    int     PosY;
    uint8_t Dir;
} guard_t;

typedef struct fieldInfo_s
{
    guard_t PrecomputedGuardState[NUM_DIRECTIONS];
    bool    Visited[NUM_DIRECTIONS];
} fieldInfo_t;

fieldInfo_t g_Map[MAP_WIDTH * MAP_HEIGHT];

char g_TraceMap[MAP_WIDTH * MAP_HEIGHT];

#define TRACE(state, check, move) {                                                       \
        while (true) {                                                                    \
            int index = (state)->PosY * MAP_WIDTH + (state)->PosX;                        \
            if ((state)->check || index == extraObstructionIndex || data[index] == '#') { \
                break;                                                                    \
            }                                                                             \
            (state)->move;                                                                \
        }                                                                                 \
    }

static void traceEast(guard_t* playerState, int extraObstructionIndex)
{
    TRACE(playerState, PosX >= MAP_WIDTH, PosX++);
}

static void traceSouth(guard_t* playerState, int extraObstructionIndex)
{
    TRACE(playerState, PosY >= MAP_HEIGHT, PosY++);
}

static void traceWest(guard_t* playerState, int extraObstructionIndex)
{
    TRACE(playerState, PosX < 0, PosX--);
}

static void traceNorth(guard_t* playerState, int extraObstructionIndex)
{
    TRACE(playerState, PosY < 0, PosY--);
}

static void traceSteps(int posX, int posY, int targetX, int targetY, int dir)
{
    int dx = 0, dy = 0;

    switch (dir)
    {
    case DIR_NORTH: posY += 1; dx = 1; break;
    case DIR_EAST:  posX -= 1; dy = 1;  break;
    case DIR_SOUTH: posY -= 1; dx = -1;  break;
    case DIR_WEST:  posX += 1; dy = -1;  break;
    }

    while (posX != targetX || posY != targetY)
    {
        if (posX >= 0 && posX < MAP_WIDTH && posY >= 0 && posY < MAP_HEIGHT) {
            g_TraceMap[posY * MAP_WIDTH + posX] = 'X';
        }
        posX += dx;
        posY += dy;
    }
}

static void precomputeMapState(int extraObstructionIndex, guard_t* playerState, bool fillTraceMap)
{
    int posX = playerState->PosX, posY = playerState->PosY;

    // we trace the player state to the next obstacle as the actual starting point
    traceNorth(playerState, extraObstructionIndex);

    if (fillTraceMap) {
        traceSteps(posX - 1, posY, playerState->PosX, playerState->PosY, DIR_WEST);
    }

    for (int i = 0; i < MAP_HEIGHT*MAP_HEIGHT; ++i)
    {
        // found obstacle, we precompute the next player state for every approaching direction
        if (data[i] == '#' || i == extraObstructionIndex) 
        {
            fieldInfo_t* field = &g_Map[i];

            int x = i % MAP_WIDTH; int y = i / MAP_WIDTH;
            
            guard_t guard = (guard_t){ .PosX = x, .PosY = y + 1, .Dir = DIR_EAST };
            traceEast(&guard, extraObstructionIndex);
            field->PrecomputedGuardState[DIR_NORTH] = guard;
            field->Visited[DIR_NORTH] = false;

            guard = (guard_t){ .PosX = x - 1, .PosY = y, .Dir = DIR_SOUTH };
            traceSouth(&guard, extraObstructionIndex);
            field->PrecomputedGuardState[DIR_EAST] = guard;
            field->Visited[DIR_EAST] = false;

            guard = (guard_t){ .PosX = x, .PosY = y - 1, .Dir = DIR_WEST };
            traceWest(&guard, extraObstructionIndex);
            field->PrecomputedGuardState[DIR_SOUTH] = guard;
            field->Visited[DIR_SOUTH] = false;

            guard = (guard_t){ .PosX = x + 1, .PosY = y, .Dir = DIR_NORTH };
            traceNorth(&guard, extraObstructionIndex);
            field->PrecomputedGuardState[DIR_WEST] = guard;
            field->Visited[DIR_WEST] = false;
        }
    }
}

bool simulate(guard_t guard, bool fillTraceMap)
{
    bool loop = false;

    while (true)
    {
        fieldInfo_t* field = &g_Map[guard.PosY * MAP_WIDTH + guard.PosX];
        int dir = guard.Dir;

        // player approached the obstacle from this direction already, so we found a loop
        if (field->Visited[dir] == true) {
            loop = true;
            break;
        }

        field->Visited[dir] = true;

        if (fillTraceMap) {
            traceSteps(guard.PosX, guard.PosY, field->PrecomputedGuardState[dir].PosX, field->PrecomputedGuardState[dir].PosY, dir);
        }

        guard = field->PrecomputedGuardState[dir];

        // guard is now outside of the map area.. so we can stop the simulation
        if (guard.PosX < 0 || guard.PosX >= MAP_WIDTH || guard.PosY < 0 || guard.PosY >= MAP_HEIGHT) {
            break;
        }
    }
    return loop;
}

int main()
{
    int startPosX = 0, startPosY = 0;
    for (int i = 0; i < MAP_WIDTH * MAP_HEIGHT; ++i)
    {
        if (data[i] == '^')
        {
            startPosX = i % MAP_WIDTH;
            startPosY = i / MAP_WIDTH;
            break;
        }
    }

    guard_t playerState = { .PosX = startPosX, .PosY = startPosY, .Dir = DIR_NORTH };

    precomputeMapState(-1, &playerState, true);
    simulate(playerState, true);

#if PART == 1
    int result = 0;
    for (int i = 0; i < MAP_HEIGHT * MAP_HEIGHT; ++i) {
        if (g_TraceMap[i] == 'X') {
            ++result;
        }
    }
    printf("%d\n", result);
#else
    int loops = 0;
    for (int i = 0; i < MAP_WIDTH * MAP_HEIGHT; ++i)
    {
        if (g_TraceMap[i] != 'X') {
            continue;
        }

        playerState = (guard_t){ .PosX = startPosX, .PosY = startPosY, .Dir = DIR_NORTH };
        precomputeMapState(i, &playerState, false);

        if (simulate(playerState, false)) {
            loops++;
        }
    }

    printf("%d\n", loops);
#endif
}

const char* data =
"....#...................................#...............#.................#.......#...#..........................................."
".........................#.........#....................................#...........................#......##..............##...#."
".....................................................................#.........................................#..#..............."
".............#........#...............................................................................#......................#...."
"....#.#.................................#......................................#...#..#..........#....#.....#.............#......."
"....................#.......#..............#.......#.#.............................#......................................#......."
"..............................................................................................#......#....................#......."
".........#.#..#...............................#........#.#........................................................#..............#"
"....#...........#.......#.......#....#...#....#..........#..........#......#...#................#.........................#......."
".......#...........................................................................................#.................#...........#"
"..................#.#....#..............................#....................#.................#....#..........#..........#......."
"...#...............#...................................................#................#........................................."
".................#..#.#.............#.#...................................#......................#....#..........#................"
".#..................#........................#..........#...........................#.......#......................#.#............"
"......#...........................................#.....#.....#...........#...........................#..............#............"
".........#...............................#.............................#.#.......................................................#"
"...#.........#.#........................#...#..............................................#...#...............#...#..#..........."
"..............................#.....................................#................#..........................#.........##......"
"..........#...........#.....#......#......#..............................#.....#......................................#..........."
"..........................#....#.........................................................#..................#...#.........#......."
"......................................#...........#.........#...............................#.............#...............#......."
".......................#........#.#....#...#...#................................................................#......#.........."
"......................#...............#................#..#.#...........#...#.......................#.........#.........#..#......"
"....#.................#..........#............#....#..............................................................#.#............."
".........................................................................................................................#...##..."
".....................#.......#................................................##.............#........#........................#.."
"........................#..#.....#.#...............#.......#.................#.............................................#.#...."
"......................................................................................#..#.............................#.........."
"..#........................................................#..........................#..............#.#.....................#...."
"...#...................#............#...#.....#....#..................................#.......................#..................."
"...#...........#..............#............................................................#....#.....#.....................#....."
"........................#..............#...................#.....#..#............................................................."
".....#....................#....................##..........#..............#......#...............#..........#.....#..........##..."
"....#.......#..........................................................#....................................#.#..................#"
"#......#.#.................................#........................................................................#.........#..."
"...............................#......#......................#...................................................................."
"..............#..........................#....................................#..........#.............#.........................."
".....#........#....#.........................#..#.................#.#.................#..........................................."
".................#..................#.#................................#..#..................................#......#............."
"...........................#.......................................................#...................#............#............."
".....................#.........#..#..........................#..................................#........#........................"
"..#................................................#.#.................................#.#..........#.....#......................#"
"..........................................................................#..................................................#.#.."
"..................................#..........................................#......................#............................."
".......#...............#..............................................#......................................................#...."
"..........................................^....................#.................................................................."
".........#.........#.........................................................................................#......#....#........"
".........#.........#.............................................................................................................."
"........#....#......................#...............#...........#..................#...........................................##."
"......#............#...........#................................................................#.......#........................."
"#.............................#..............................................................#..............#....................."
"...................................#...........#...................................................#........#..........#.........."
"....#.....................................................................................................#...........#......#...."
"....................................................#....#...................................#...................................."
"............#........#............................#..........#.............................#.....#..#.#..........................."
"...........#.................................................................#.............#......................................"
"....#.........................................#.#.......#...............#...........................#............##..............."
"..................#..............#...#........................................................................#....#...........#.."
".....................#.....#...#.....#.............#..............#...#...................................#......................."
".#...#.....#.............................................#...........#....#......................................................."
".#.....#.............................#................#......................#........................#.........................#."
"......................#.........................................#.............................................#.................#."
"...#...#....................#.................................................................#............#....#.......#........."
"...........#......#...............................#.......#......#........#..........#...........................................#"
"......................#....#..............##...........................................................#..........#..............."
".#......#.....................................................................#..#....#.....................#....................."
"....##....#...#.........#.............................#.........#...................#.............#....#................#........."
"..................................................................#...............................#..............................."
"....#.................#.#........................................................................................................."
"........................#..........................#...........#...................................#.#.......#...................."
"...........#.....................................................................................#...............................#"
"...........................................#..................................#..................................................."
".....#.........#......#..........#.........#.................................................................................#...."
"....#.....................#....#..#.........................................................................#..#.................."
"........................##..#........................#...#.........#.................#......................#..#....#............."
".............#................#.......#........#............................................................#......#.............."
"#....#................................#.............#..........#........#.....#...#..........##.....................#............."
"......#...#......#..........................................................................................#....#..#.........#..."
"#.................#..............##....#........................#....#...........................................#..........#.#..."
"........................#.#..#........................................#.............................................##............"
"..........#.........#.........................................................................................##.................."
"....#....#...........#.................#......................#........................#...#....................................#."
".......#..................................#..................#...................#...............................#.....#.....#...."
"#................................#...........#................##...#............#................................................."
".............................#...#....................................#...................................#...#..........#...#...."
".#......#.........#...#.......#.................##....#..................................................#...#...................."
"...........#........................................................................................................#............."
"......................................#......#..........#.....#.....................#...................#.#.................#....."
".....................................#............#................................................................##............."
".......................................#....................#...........................................##..#....................."
"..........................#.................................................................................#....................#"
"...........................................................#............#.........#..#....#.#............#.....#.................."
"....#.....................................#...........................................#........#.....................#............"
".............#.............#................#..........................#......................#..........................#........"
".........#.................#......#............#....#.#.............................#.......##......................#.#.......#..."
"..............................................................................................................#..................."
"#...#...............................................#...................#........................#...............#................"
".......#...#.......#..#..#..#..........#.........................................................................................."
"......#.##....................#......#........#............#................#.............#...................#............#......"
".....#..#......#.......................#..............................#...............................#..........................."
".#.................................#......#..............................................#........................................"
"....#...........................#..#........#...............#..#.......................................#......##.#.........#......"
"..................................#..................#......................#.....................#.......#.....................#."
".........#....................#....#...............................................#...................................#.........."
".........................................................#...#...............##..#...............................................#"
".#..#.............#.............#....................................#....................#.....#..#..........................#..."
".................#.........................#..#........................................#.................................#........"
".....................#....#................................#......#..............................................................."
"...............#..........................#...........#.............................................................#.........#..."
"...........##.......#................#..............................#..........................#....##.....#...................#.."
"......................#........#........#.........#..................................................##..#........................"
"....#........................#......................#.#..................#....#..................#.....................#.........."
".................#......#...#...................................#...............#....#.........#............................#....."
"#.................#...............................#......#..#..............................................###...#.......#........"
"..........#...........#..........................................................................................................#"
".......................#......................................#.................#.......#........#................................"
"..#.......#..#.............................................................................................................#......"
"#.........#......#........................#.#..............................................#...................##................."
"...#....#.....................................#..................................................................................."
".....................#.....................................................................#........................#.....#......."
".....#..#...............................................................##......#.#......#..#.#.......#........................#.."
".......#..........#....................................#.........#.................#.................#.....................#......"
"..............##.................................................#................#.........#.#............#........#............#"
".....................#.............#....................#...#.................#.........#........#................................"
".............#...........................................#........................................................................"
".....#...#.............#..............#..............#..................................................................#......#.."
".....##...................................##.....#.....#..#.........#...............#..........#.....#............#.#...........#."
"....#..................#.........#....................#....................#...#....#..............##............#..............#."
"..................#..........#.#.....................................#....#..............#.......#.....#...............#......#..#"
"..............#.........#.............................................................................................#...........";