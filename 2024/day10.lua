local PART = 2

function pack(...)
    return {n = select("#", ...), ...}
end

function findTrailheads(data)
  local trailheads = {}
  for y = 1, #data do
    for x = 1, #data[y] do
      if data[y][x] == 0 then
        table.insert(trailheads, pack(x,y))
      end
    end
  end
  return trailheads
end

function calculateScoreForPath(data, startX, startY)
  local directions = {{-1,0},{1,0},{0,-1},{0,1}}
  local queue = {pack(startX, startY)}
  local visited = {}
  local endpointsReached = {}
  
  local function markVisited(x, y)
    visited[y] = visited[y] or {}
    visited[y][x] = true
  end
  
  local function hasVisited(x, y)
    return visited[y] and visited[y][x]
  end
  
  markVisited(startX, startY)
  
  while #queue > 0 do
    local posX, posY = unpack(table.remove(queue, 1))
    
    for _, direction in ipairs(directions) do
      local nextX, nextY = posX + direction[1], posY + direction[2]
      
      if nextX >= 1 and nextX <= #data[1] and nextY >= 1 and nextY <= #data and not hasVisited(nextX, nextY) then
        if data[nextY][nextX] == data[posY][posX] + 1 then
          if data[nextY][nextX] == 9 then
            local key = nextY * #data + nextX
            endpointsReached[key] = (endpointsReached[key] or 0) + 1
          end
          
          if PART == 1 then
            markVisited(nextX, nextY)
          end
          
          table.insert(queue, pack(nextX, nextY))
        end
      end
    end
  end
  
  local numberOfEndpointsReached, numDistinctHikingTrails = 0, 0
  for _, count in pairs(endpointsReached) do
    numberOfEndpointsReached = numberOfEndpointsReached + 1
    numDistinctHikingTrails = numDistinctHikingTrails + count
  end
  
  return {numberOfEndpointsReached, numDistinctHikingTrails}
end

function parseData(data)
  local lines = {}
  for line in data:gmatch("([^\n]*)\n?") do 
    table.insert(lines, line) 
  end
  
  local topoData = {}
  for y, line in ipairs(lines) do
    topoData[y] = {}
    for x = 1, #line do
      topoData[y][x] = tonumber(line:sub(x, x))
    end
  end
 
  return topoData
end

data = [[
101234653436698943210876543298108967890123211
900945762567787651028945054167211876965254300
812876851008632112987632167054340105874367891
743987945219541003456542108981233234567809892
657641434349898764565876232190543456452912763
898530125896701651698965945087612387301103454
101421056787672340789234876231201293219010989
012336765410589121470125960140340184678321670
987449870323431034561076054057653296501234521
876558901210120345665780143968934187410345438
034569821025001256676891232877065056309654589
125678438136789867589872301986174145218789678
678776569245234798434565432765289036785890541
589989478910135652329806567874376123896781030
431276321210023101210715432990145678765432121
120345290923412302345620121087230109650187656
098010187874503210989430101256521212341090347
187623456365694567876543232344560301032181298
012510589456787655469854741023478912345672107
143421674307897846988767858910890109852109856
231256014210978987671056967378765210763296705
140347123900389034502340191269854307894585014
051298034891276123216521780350123456765674323
565434540762345637897435615443210523456001298
876529651057850136988904306782107610987123367
985018782348943245077211216790108901278994453
123427890167654432106310345889299870122185432
010568921211234501215445432976387761233076541
129877432100235676301456701265456654394567650
431066523231145985490389876014012534585658969
302309012694046796781201078923453421673215678
213218906783459873212212562112969010984504301
304567815612163654304323453007878123435643210
412359854309072345323456894314365036521754965
563456743218781896210567765101254307810867874
694105678907690787890698989210345218987980123
787234563210581654321787876307896210898943321
894563454671410010987345665456987346787652450
763674589582323225676298767645459855898101067
652983673497654134570156958912378764306678998
341672102108987010987667843003569013215463210
030501012896109823478766542103454320176354501
125418923787210734569651033212169010083296101
654327654654323601234569124349078321190187632
789210125345434512103678765678767456783276543
]]

local g_TopoData = parseData(data);
local trailheads = findTrailheads(g_TopoData)
local sum = 0 
for _, trailhead in ipairs(trailheads) do
  local x, y = unpack(trailhead)
  sum = sum + calculateScoreForPath(g_TopoData, x, y)[PART];
end
  
print(sum)