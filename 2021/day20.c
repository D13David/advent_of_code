#include <stdio.h>
#include <malloc.h>
#include <stdlib.h>
#include <string.h>

#define PART 2

const char* lookup0 = "..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..##"
"#..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###"
".######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#."
".#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#....."
".#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.."
"...####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#....."
"..##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#";

const char* data0[] =
{
	{"#..#."},
	{"#...."},
	{"##..#"},
	{"..#.."},
	{"..###"}
};

const char lookup1[] = "##..#.####..#.#.##.#######.######.#####..#...##.###....#..#.##..#....#.#.##"
".#.#.#...###..###..#.#..#.#####.#.#.##..##.#.###.#..##.###.###...####.#####"
"....#....#..#.#...#.#.#.#.#...#####...##..####.##.##...#.##.#####........#."
".#####..##.##..###########....#.##.#####.##..#####...#..#.#.##...#.#.#..#.."
".####......#.#.####....##.#.##.####..##..##.#.......#...#.###########.....#"
"##.#######....##.#.#######..#.......###.##....#.#..#....##..#.###.#..#.###."
"###.##..##.#.#...#.#.....###.#.#....###..#.....##.#.#####.....";

const char* data1[] =
{
	{"#.#.#.###...#####.#.###...#.#..##.#.#..#.#.#####.##......##..#.....#.#..#.##.#..##.##.#.#.#.##...#.."},
	{".#.##..#.##.#..#...##..##....##....###.##.#..##..............#####.#.###..#..####....##.##.#.#....#."},
	{".##.##.###.##.#...#.#..#.###.##.####..#....#.#.####..##.####.###....##..###.#.#.....#..##.##.##.#..."},
	{"..#.##.####.####..##..####.##.###..#.#..#..##.#..#..####.#.....####.#..#####...###.##...#.##...###.."},
	{"###..##.#.#######.##....#.#.###..###..#..#####..#....##.##.###....#..#####.#..##.#...######.##..#.#."},
	{"....#.#.##..##.####..###..#####.#.#.##....#..#...##########..##.#...#..#.##.#####.#.###..#.#..######"},
	{".#....#.........##...#####.##.......#.###.#.###..###.#..##.###...####...........#..######...##..####"},
	{"...#.#..###.###.#.#.##.#.###.#.######.#####.#...#.#...##..###.##.####.###..#..#.####.####..#.##.#.##"},
	{".#.#..####..#.#.#.##.......##..#..##..#..#.#.#..##..#..##.#.#.##..###....###.###.###..#....#.#..#.##"},
	{"#......###.##.#..###.#.#.###.#...#..#.#.##.##...##..####..##.###..#...######...####..##.#####......#"},
	{".#...###.#.##.##...##......##..#.....###.###.#.#.####.###...#...#...#.##..#.##.###.#.#..#.....#####."},
	{".##..#..#.#..#..#.##..#..###..##.##....#.#....#.####.##.###.#...###.#..###..###..#......##..#...##.#"},
	{"..##..#..#..#..##.##...###.#.##.....#..###..##...##......#.#.#..#..#..#.#...#...#.........#.##.#...#"},
	{"#.###.#..##..##...#.#...#......###.....##.######..#....#...##.###..#..####...##......#.##...##.##.#."},
	{"####....#.#..##.#.#.....##.##.#....#.##...###.#.#.#..##...#####.##.#.......##.#..#.##.....###.#.#..#"},
	{"...#.#...#.......#.##.#...#####...##.##.#....###.......##...#.##.#.##...#.#.....#.#####.###.#####.#."},
	{".###..#..##..####.##.#.###.###.###..#...###.#######...#...#.###..###..#..###.....##..#.###......##.."},
	{".#####.##.#..##....#.########..####.##...###..#.###..#..#.#####...#...##.#.##.#.....##.#..#####...##"},
	{"...###......##.#.#.##...#....#.##..#.##.##..##.#.#.#####....#..##....##..##.#.##.....#..#.#..####..#"},
	{".#..###....#....##.#..#.##...#.#..#.#####.###.#.#..#.#..#.##.#....##.#.##...#####.#####...#...##.#.."},
	{"#.#.#...#....#.#..#.##.#....#.#.###..##.##..#.#.#.....######.....#.#..#.###.#..##.##.#.###..#.###..."},
	{"..#.#.#.#......###..##.#.##.##.###...###..#..####...#.#.##.###.#..#.#.#...##..##..##..#..####.##..##"},
	{"...#.#.#...#..######.##.##.##...#..#..#..#..##.###.#....#..##..##.##.#......###.#.#..#....#.#...#..."},
	{"...#.##...#.....###...#.##.###...####.#####....##.#....##.#...#.#..##..##.#..#####.......##.#...#.#."},
	{"##.#.#######.###...#.####..#..###.#.#..#.#.#.###..##.#.##.....#####..##.#...##...#....###.#.#...##.."},
	{"##.#....##.##.#.###.......##..#.##..#.#......#..#.##.#..##.###..##...#...###...#..##.###...###....##"},
	{"...#..#..#...##...#.###.#######.#.#....#..#.#####.#...#####....###.######....#.#..#.....##.#..##.##."},
	{"...#.##########..#.##..###....##.....####.##..###..#.#.####..###.###...###..##...#.#.###...#...#.#.#"},
	{".#...#.#.....#.##.#.#.##...#....#.....#.#.....#...##..##.#.##..#....#.##.#######.##.##....#...#..###"},
	{".#..#....#.#...##.##.##...#.#..##.##..#...#.###..#.##.###.#...###....####..#.##..####.#.#..#########"},
	{"#.###.#..#####.##...##.##...#.#####...#..###....#.#..#..#.##..##.#..######..##.######.#..#.###..####"},
	{"##..#.##.##..#.....#...#...#####.##...##.#.##.####..#.###.##.#.....##..#....#.#..###.#.##.#.#.###..."},
	{"#.##..#.#.....#..#.##.###..###...##..#.#........##.###.#.........###.....#..#.##.##...###...#..###.#"},
	{"#.....##.#.....#.#..###..#.#...#..#..###.#......###..#.######..#...##.#.#...#.#.#.#..##.##...##.##.."},
	{"###...#....#..####.#..###..#.#.#..##.###..##.####...##.#..###.#.####.#..#....##...#.#...###..###..#."},
	{"..##..#..#...##.....##..#.##.##..#.#.####.##.###.#.#####......#.#..##.#...##.#.#.####..###....##...#"},
	{"..##.#....#.####.....#.#.##....###..##..##..##....#...##...#.#.#.########...####....#..#.#.###.#.#.."},
	{"###.#.##.###......####....##.##.#...###.#.....#....###.##.#######.##.####.##.#.###.####..#......#..#"},
	{"...#..#..#.#....#.####...##.#..##.#####.###.#..#.##....#.##.#..####.#.#...######..###.#.######.##.#."},
	{"####.#....#....#...###....#.#.#.##.#..##.#.####..##..#...#......#######.#.#.#.##..#.....#..##......."},
	{"..##.#.#...#.##...#..#..##.#.##.......#.##.####..#.#.....#..#.....###.##.#.#...###..#..#...#.#.##.##"},
	{".#.########..####.#.###...##...#........#.####.####.#.#####.###..#####...##.##..#..#.#......#...###."},
	{".#...#.###.#.#...#.#.#..####.##.#.####..#..#.##.....#####..#######.##....##...###..####.#.#####....."},
	{"###.#.######.#.#.#..#.#....##.....#...###.####.#.#..#.....##.##.###.#.####.....##.#....#...##..#.#.."},
	{"##...#.....##.####.###.#.#.#.##.#.#.##.####....#.######....#....##......#....#..#.#..####.#.#.##.##."},
	{"..#.##.##...#.#.....#.##.##.######.####..#...#..###.##..##...#.####.##....##..#.###.#.####.###.#...#"},
	{"#.##.##.##...#.....##.#.##.#.#####.#.#.....#..##...#.####...######..#....#.#.##..###.############..#"},
	{"#.##.###...#..#.#.....####..#..#.#..#.#########...#..##.#.#...#...#.#.#...#...#.#..##.#.#..####.#..#"},
	{".##.##.##......##.#..###.#.##.####..#..##...###...##....#.##..#####.#.#.#...#.#.#..###..###..###..#."},
	{".##.#####..#.#.#.####.#.#.##.##.....######.#..###..#####..##....#.#.#.##.##.#...#.#.#.#.####.##.##.."},
	{"...#....#.##...#####.#.###.####...##.#...##.#.#..#.#...####......#####.#.##.#..#####.#...#..#...#..."},
	{"#..#.##...#.#..#.###.#.#.#...#.##.##..#.##...###.######..#.##..###..#.#.###.##.#.###.....#..#.#..###"},
	{".###.#........##..##......##.#######.#.#..###...#..#.##..####.#.####..###...#..##.###.##.###.#...#.."},
	{"###.###..##..##.#..#.##....#####.##.#....#..###..#..#.#...#.#.#......#.##..#####...###..##.#.....###"},
	{"##.#..###...#.#..###.....###.###.#.#..#...#.#...###..#.....########.##......#...##..#.#.#.#..#.#.##."},
	{"#..##.#.#.##.####..##.###..#...#..#..###..##...#..#......#.#....##......####.#.###...##..###...#...#"},
	{"..#..##..####..###..#####.#.#.##.##.##....##.#.#.##...#......#...#..###....####..#.##..#.###....#.##"},
	{"###..#######...#...######.#######.##..##..###.....##..#...#..##..#######.....#..##..##..##..#.####.."},
	{"..#.###.#.##...#.#.##.#.#.###..##.....###.###.#..####.#...##..##...#..#.###.##.##.####....#...##...."},
	{"##.#.#...##.....#.#.#.##..##..####....#.#...#.#.#.#..#..###..###.#.#.###..#.###..#..###...##.......#"},
	{"###...##..#.#.####..#..#...##..#..#.#.#.#...###.##.###.###.#####.#.....####..#####.###.##..###..#..."},
	{"..###.#####.##...#.####....#.#...##...##....###......###...#.#.#.......###..#..#...#####.#..########"},
	{"#.####....#.#.#.#.#.#.#..#.##...#.#.###.#.##.##..#..#.###.##.##....##.###...#..##.#.....##.###.##.#."},
	{".#.#.##..#.#.##...##.####.#...#.#..##.#..##.#.##..##..#.####.##.#...##..###.###..###..#.#....###.##."},
	{"####.#...#....####.###.####...##.....#######.....###....##.#........#.###.....#.#.#.###.####.##.#.##"},
	{".#..#..#..####.#.##..##...###..###.###...######.###....##...#.##..#####.#.####.......#...#.##.#....."},
	{".#..#....#...#####..#..#...#..#...##.#.##.#.##.#...#.##..##.####..#.###.###.#..##.###.......###.#..."},
	{".##.##.#..#...###.####.#.###.#...#..#.##.#..##.#.#.##..####.#####....##.###.###....#....#..##.###..#"},
	{"..#..#..##.###...#.###.#.###...###....##.##.#.#..#..#.##.#.#.....#####..#.##.###.#.....#..#.#.######"},
	{"#...##..###.###.#..#....#..#.##..##.###..#.#.#..##...#.##..#..#.#####.......#.##......##.#.#..#..#.."},
	{".#....####.##.###.##....#...###.#..#####.#..#..##....####.#...####.#..###...#....#.#..####..##....##"},
	{"##..#####..#..#..#.#####.#.###..#....#..##.#...#.###..#..#####....##..##.#......##.###..#.#...#.###."},
	{"##.......#..##.#.#.##.#...#.########.#.#.##..##.#..###.....#.#..###...##..#......##.##.##......#..##"},
	{".##...##.#.#.....#.#.#.#....###..#..##...#.#.#.##.####.##.##.##.....##.#.....#.#.##..#.#.####.#..##."},
	{"..#..#....###.....#.###...###.###...##....##.#.#.##....#..######...#.##.#.#...##.#....##########.###"},
	{".....#.#.#.##.#.#.....#..#.#.#..####.##.#...#.#.....#####.###.#...#...#....###.#.......#.#..#...##.."},
	{".##..###.#....#..#.##.#.#.#..#..#.##.....#####..##.....##.##....#...#..##..#..#.....###..#...##.#..#"},
	{"#.#.#..#.#...#.#.#.#...#..#.#.###.#.....#...#...#.###..######.#..###..####..####...##..#.....#.####."},
	{"#..##........#.#.##.#.##.#.#####..#....#####.####...#....#.#..####.#..###.#.###..##..#....##.#...#.#"},
	{"..#....#....#....#.#.####......#.##...###..###.#.#..#.#.#.###..#.#.###.....#..###..##..#.##..#.#..##"},
	{"#...#..#.###.#....#.#.#.#..#.####..#####..###.....##..#.###..#.##.#####.#.#....###.###..#.##.###..#."},
	{"#####.###.#.#.####..#.###.##..#.#.#..#........#########.##.#.#.#..##.#...#..#...#.##....#..##.##.#.#"},
	{"#.##.....#.##.#..##.....####.##..#..#...#.#..#.#######..#.##.#..#.##...###.###....###..#.##.##.####."},
	{".#....##########..#.#..###..#.#.#.#...#..#.#..###..##....######.###....#...##...#...#..###.#.#...###"},
	{"#.#.#..#.##.....##..####.###.#.###.#..#....#.#...#..##.#.#.##...#..#.......#...#.....##.##.##...#..."},
	{"#....#...#..##..............##.###.#.#####.##..#########..#.#..##.###..##.##..#.##.##..##..#...###.#"},
	{"##...#.####...##.....##.##....##.######.##.#.##.####..##..#####..#..#.#.###.....#..##..#.#...####..."},
	{"#..#.####.#....##..#.###.##.#.#.#.#...##.##.#.####......###.#.####.#####...##.#.#.##.#..######..#..#"},
	{"..##...##.#.##.##.#.#..#....#.##.##.#..###...######.####.#......#..#.#..#.#####.....#.#.#..#......#."},
	{"#......#.###.#......###....##.##.#.#...#...##.#.#.######..#.##.####..#..#...#.##.###....#......####."},
	{".#.#.#####.###.##.##......#......##.#.....##..#.###..#.##....##.#.##.#####..##.##..#####.#..#...##.#"},
	{"##.#.#.#..#.###.##.#.#....##.#.##.....#.#.#.#..#...#.....#.#.#.#.#####....#######.#..#..##..##.###.#"},
	{"..#.##..####.#.......#....######...####.#.#.###.#...######.#....##.#.##.##.###.#..#...##...##..#...."},
	{".#.##.###..###........##.##.####.####.#...#.##....#####.##..####...##.##..#.#.####.#####....##....#."},
	{"#.##.#.#.##......#.#####.#.#..###....#...#...#..##..##.#.#.####..###.#.#..######.###.......#..#.####"},
	{"..##.#.#...##...#.....#......#..##.#.##.###.#.###..#..#.#.####.##.#.####.#.####.#.#..###.##.###..#.#"},
	{"#........#.#..#.....##..#...##..##..##..#.##..##.#.####..####.#.#.#####..###.#.....#.#....#..#..###."},
	{"#..##..#.######.....##..#.##..#..###.####.#.#....#.#.........#####.####..##.####.##..#.#..#..#.###.."},
	{"##.##..##.####..#.#...#..#..#..##.....##..#...#.###..#.............##.#...###....##.####.#.###..#..#"},
	{"#..#.#.###..###....#####.#.#.#..#.##.#.##...##..###.##..###....#.###.##..#.#.#.#######.##.#.#.#..#.."}
};

#if 0
#define WIDTH 5
#define HEIGHT 5
#define initialData data0
#define lookup lookup0
#else
#define WIDTH 100
#define HEIGHT 100
#define initialData data1
#define lookup lookup1
#endif

typedef unsigned char byte;

typedef struct vec2_t
{
	int x, y;
} vec2;

typedef struct buffer_t
{
	byte* data;
	int width;
	int height;
} buffer;

buffer buffers[2];
int sourceBufferIndex = 0;

buffer* sourceData()
{
	return &buffers[sourceBufferIndex];
}

buffer* targetData()
{
	return &buffers[!sourceBufferIndex];
}

void swapBuffers()
{
	sourceBufferIndex = !sourceBufferIndex;
}

void resize(struct buffer_t* buffer, int width, int height)
{
	if (buffer->data) {
		free(buffer->data);
	}

	byte* data = (byte*)malloc(width * height * sizeof(byte));
	memset(data, 0, width * height * sizeof(byte));
	buffer->data = data;
	buffer->width = width;
	buffer->height = height;
}

int sampleSource(int x, int y, int border)
{
	struct buffer_t* buffer = sourceData();

	if (x < 0 || x >= buffer->width || y < 0 || y >= buffer->height) {
		return border;
	}

	return buffer->data[y * buffer->width + x];
}

void applyFilter(int border)
{
	const int offsets[3][6] =
	{
		{-1, -1, 0, -1, 1, -1},
		{-1,  0, 0,  0, 1,  0},
		{-1,  1, 0,  1, 1,  1}
	};

	struct buffer_t* buffer = targetData();

	for (int y = 0; y < buffer->height; ++y)
	{
		for (int x = 0; x < buffer->width; ++x)
		{
			int index = 0;

			for (int i = 0; i < 3; ++i)
			{
				int sx1 = offsets[i][0] + x - 1; int sy1 = offsets[i][1] + y - 1;
				int sx2 = offsets[i][2] + x - 1; int sy2 = offsets[i][3] + y - 1;
				int sx3 = offsets[i][4] + x - 1; int sy3 = offsets[i][5] + y - 1;

				index = (index << 3) | ((sampleSource(sx1, sy1, border) << 2) | (sampleSource(sx2, sy2, border) << 1) | (sampleSource(sx3, sy3, border) << 0));
			}

			buffer->data[y * buffer->width + x] = lookup[index & 0x1ff] == '#' ? 1 : 0;
		}
	}
}

int main()
{
	resize(&buffers[0], WIDTH, HEIGHT);

	byte* data = sourceData()->data;
	for (int y = 0; y < HEIGHT; ++y)
	{
		for (int x = 0; x < WIDTH; ++x)
		{
			data[y * WIDTH + x] = initialData[y][x] == '#' ? 1 : 0;
		}
	}

#if PART == 1
	const int stepsToSimulate = 2;
#else
	const int stepsToSimulate = 50;
#endif

	int infiniteBorderValue = 0;

	for (int i = 0; i < stepsToSimulate; ++i)
	{
		buffer* buffer = sourceData();
		resize(targetData(), buffer->width + 2, buffer->height + 2);
		applyFilter(infiniteBorderValue);
		swapBuffers();

		// toggle infinite border value if lookup maps 0 to 1 and vice versa
		infiniteBorderValue = lookup[infiniteBorderValue * (_countof(lookup) - 2)] == '#';
	}

	int litPixels = 0;
	buffer* buffer = sourceData();
	for (int i = 0; i < buffer->width * buffer->height; ++i)
	{
		litPixels += buffer->data[i];
	}

	printf("%d\n", litPixels);

	free(buffers[0].data);
	free(buffers[1].data);

	return 0;
}